## Upgrade the safety module to v1.5 PART 1

_Updated as of block [17192842](https://etherscan.io/block/17192842) at 5/5/2023, 3:07:11 AM ET_

- ID: 214
- Proposer: [0x329c54289Ff5D6B7b7daE13592C6B1EDA1543eD4](https://etherscan.io/address/0x329c54289Ff5D6B7b7daE13592C6B1EDA1543eD4)
- Start Block: 17176895 (5/2/2023, 9:18:59 PM ET)
- End Block: 17240895 (5/12/2023, 8:38:40 AM ET)
- Targets: [0xe427FCbD54169136391cfEDf68E96abB13dA87A0](https://etherscan.io/address/0xe427FCbD54169136391cfEDf68E96abB13dA87A0#code)
- Executor: [0x79426A1c24B2978D90d7A5070a46C65B07bC4299](https://etherscan.io/address/0x79426A1c24B2978D90d7A5070a46C65B07bC4299) (unknown executor)
- Simulation: [https://dashboard.tenderly.co/me/simulator/2350f386-3ec9-440c-a17f-d3d0205f9974](https://dashboard.tenderly.co/me/simulator/2350f386-3ec9-440c-a17f-d3d0205f9974)

<details>
  <summary>Proposal text</summary>

# Summary

This AIP presents the community with the opportunity to upgrade the safety module to v1.5 which introduces:

- a new slashing mechanism
- new cooldown mechanism
- a transfer hook to be used by GHO

The new version also adds some convenience features like permit support or the ability to claim and stake in a single transaction.

# Motivation

On September 2020, the Aave Safety Module was introduced into the ecosystem, to improve the protection of the liquidity protocol, adding an extra utility for the AAVE token: AAVE or AAVE/WETH BPT holders stake their assets to act as a defensive layer in front of any shortfall event.

Since then, apart from really minor upgrades, the contracts have remained the same and in parallel, the system has been adopted by other communities.

As part of our engagement with Aave, we identified that the Safety Module is a clear area of improvement in the ecosystem, from 2 different standpoints:

- Technical. Improving the basic existing mechanisms of the contracts, but without disrupting radically the current design of the SM.
- Conceptual. Making more efficient the SM dynamics (e.g. slashing, rewards distribution rules, etc), by modifying the whole design.

## New slashing mechanism

On the running SM v1, in order to slash, an ad-hoc governance proposal is required, involving important development overhead, which is not ideal.

The new SM v1.5 adds an enhanced mechanism to facilitate slashing of the underlying by tracking an exchange rate between the staked AAVE and the stkAAVE received by stakers. The mechanism is simple: when somebody stakes AAVE, they receive a certain amount of stkAAVE, which no longer is 1:1 equivalent, as it keeps track of slashing (meaning with the same stkAAVE, stakers are able to claim less AAVE).

## New cooldown mechanism

The current cooldown on SM v1 consists of a time delay of 10 days to be respected whenever anybody wants to redeem the staked AAVE. At the moment, this cooldown is affected by in/outflows of stkAAVE, both via transfer() and stake()/redeem(), in order to protect the system from being gamed. Even with this protection mechanism the mechanism is currently gamable, by staking aave within the active cooldown window to [extend the window](https://github.com/bgd-labs/aave-stk-v1-5/issues/6).

This mechanism is not really optimal and adds important complexity, so on v1.5 has been changed to the following: after activation of cooldown, a staker will be able to redeem the minimum balance he will hold between cooldown activation and redeem window. Apart from the user-level cooldown new mechanics, we also propose to increase the cooldown period from 10 days to 20 days.

## GHO Transfer hook

The Aave community has already approved the deployment and activation of the GHO stablecoin and the first facilitator will be the Aave v3 Ethereum pool.

In order to enable the discount mechanism by holding stkAAVE described on the GHO proposal, the design of Aave Companies requires to introduce of a piece of logic on the stkAAVE transfer(), in order to “notify” the GHO facilitator system of stakers’ balances.

We have evaluated this and we think it is acceptable, so it will be included in this upgrade. From a technical perspective, stkAAVE includes logic protections to remain unaffected if anything would go wrong with the GHO facilitator, which at the same time should be considered a trustable entity, as it will be controlled by the Aave governance.

## Misc

The upgrade also allowed us to add some smaller ux improvements:

- a new `stakeWithPermit()` is introduced on `stkAAVE`

- convenience methods to batch claiming and staking/redeeming into a single transaction have been added as `claimRewardsAndRedeem` and `claimRewardsAndStake` have been added to `stkAAVE`

- `preview*()` methods have been added to follow the `4626` standard more closely, even if there's no objective to be compliant

# Specification PART 1

The proposal is split in two parts, as currently the `stkAAVE` is controlled by the `LONG_EXECUTOR` where `stkABPT` is controlled by the `SHORT_EXECUTOR`. As there's a single executor per proposal `Part 1` upgrades the `stkAAVE` implementation and targets the `LONG_EXECUTOR`. `Part 2` upgrades the `stkABPT` implementation and targets the `SHORT_EXECUTOR`.

The proposal will:

- transfer ownership of `stkAAVE` to a `ProxyAdmin` controlled by the `LONG_EXECUTOR`. This is done for consistency reasons with `stkABPT` as the `SHORT_EXECUTOR` cannot be the `SLASHING_ADMIN` and `PROXY_ADMIN` at the same time.

```solidity
IInitializableAdminUpgradeabilityProxy(STK_AAVE).changeAdmin(
  address(AaveMisc.PROXY_ADMIN_ETHEREUM_LONG)
);
```

- deploy the new implementation while maintaining the current values:

```solidity
StakedAaveV3 newImpl = new StakedAaveV3(
  IERC20(AaveV2EthereumAssets.AAVE_UNDERLYING),
  IERC20(AaveV2EthereumAssets.AAVE_UNDERLYING),
  GenericProposal.UNSTAKE_WINDOW,
  GenericProposal.REWARDS_VAULT,
  GenericProposal.EMISSION_MANAGER,
  GenericProposal.DISTRIBUTION_DURATION
);
```

- upgrade `stkAAVE` implementation. The `SLASHING_ADMIN`, `COOLDOWN_ADMIN` and `CLAIM_HELPER` are all initialized as the `SHORT_EXECUTOR`. `MAX_SLASHING` is set to `30%`, `COOLDOWN_SECONDS` is increased to `20 days`:

```solidity
ProxyAdmin(AaveMisc.PROXY_ADMIN_ETHEREUM_LONG).upgradeAndCall(
  TransparentUpgradeableProxy(payable(STK_AAVE)),
  address(newImpl),
  abi.encodeWithSignature(
    'initialize(address,address,address,uint256,uint256)',
    GenericProposal.SLASHING_ADMIN,
    GenericProposal.COOLDOWN_ADMIN,
    GenericProposal.CLAIM_HELPER,
    GenericProposal.MAX_SLASHING,
    GenericProposal.COOLDOWN_SECONDS
  )
);
```

# References

A list of relevant links like for this proposal:

- [ProposalPayloads](https://github.com/bgd-labs/aave-stk-v1-5/blob/main/src/contracts/ProposalPayload.sol)
- [StakedTokenV3](https://github.com/bgd-labs/aave-stk-v1-5/blob/main/src/contracts/StakedTokenV3.sol)
- [StakedAaveV3](https://github.com/bgd-labs/aave-stk-v1-5/blob/main/src/contracts/StakedAaveV3.sol)
- [sigma prime audit](https://github.com/bgd-labs/aave-stk-v1-5/blob/main/audits/Sigma_Prime_Aave_Safety_Module_Security_Assessment_Report_v2.pdf)
- [Certora audit](https://github.com/bgd-labs/aave-stk-v1-5/blob/main/audits/Certora_FV_Report.pdf)
- [Certora specs](https://github.com/bgd-labs/aave-stk-v1-5/tree/main/certora/specs)
- [Test Cases](https://github.com/bgd-labs/aave-stk-v1-5/tree/main/tests)
- [Technical review by aave companies](https://governance.aave.com/t/technical-review-aave-safety-module-v1-5/12436)

# Copyright

Copyright and related rights waived via [CC0](https://creativecommons.org/publicdomain/zero/1.0/).

</details>

### Checks

#### Reports all state changes from the proposal ❌ Failed

Errors:

- Transaction reverted with reason: ONLY_QUEUED_PROPOSALS

#### Check stack trace of the proposal ✅ Passed

Info:

- There is no SELFDESTRUCT inside of delegated call

#### Reports all events emitted from the proposal ✅ Passed

Info:

- No events emitted

#### Check all targets are verified on Etherscan ✅ Passed

Info:

- Targets:
  - 0xe427FCbD54169136391cfEDf68E96abB13dA87A0: Contract (not verified)

#### Check all touched contracts are verified on Etherscan ✅ Passed

Info:

- Touched address:
  - 0xD73a92Be73EfbFcF3854433A5FcbAbF9c1316073: EOA (verification not applicable)
  - 0xEC568fffba86c094cf06b22134B23074DFE2252c: Contract (verified) (AaveGovernanceV2)

#### Runs solc against the verified contracts ✅ Passed

Info:

- No contracts to analyze: only the executor and governance are touched

#### Runs slither against the verified contracts ✅ Passed

Info:

- No contracts to analyze: only the executor and governance are touched
